package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.model.AggregateOrganizationQuery;
import org.opentestsystem.rdw.olap.model.ClaimOrganizationQuery;
import org.opentestsystem.rdw.olap.model.LongitudinalOrganizationQuery;
import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.olap.model.TargetOrganizationQuery;
import org.opentestsystem.rdw.reporting.common.model.AbstractAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.AggregateRow;
import org.opentestsystem.rdw.reporting.common.model.ClaimAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.model.LongitudinalRow;
import org.opentestsystem.rdw.reporting.common.model.Measures;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.opentestsystem.rdw.reporting.common.model.TargetReportQuery;
import org.opentestsystem.rdw.reporting.common.model.TargetRow;

@SuppressWarnings("unchecked")
final class AggregateTestUtils {

    static final ActiveAssessment assessment = ActiveAssessment.builder()
            .id(1)
            .subjectCode("Math")
            .gradeCode("3")
            .examSchoolYear(1999)
            .label("Assessment")
            .build();

    static final Measures measures = Measures.builder()
            .avgScaleScore(2500)
            .avgStdErr(12)
            .level1Count(1)
            .level2Count(2)
            .level3Count(3)
            .level4Count(4)
            .build();

    static AggregateRow.Builder reportRow(final OrganizationType type, final Long organizationId, final DimensionType dimensionType) {

        return AggregateRow.builder()
                .dimension(Dimension.builder().type(dimensionType).build())
                .assessment(assessment)
                .measures(measures)
                .organization(Organization.builder()
                        .organizationType(type)
                        .name("schoolName")
                        .id(organizationId)
                        .naturalId("schoolId")
                        .build());
    }

    static LongitudinalRow.Builder longitudinalRow(final OrganizationType type, final Long organizationId, final DimensionType dimensionType) {
        return LongitudinalRow.builder()
                .dimension(Dimension.builder().type(dimensionType).build())
                .assessment(assessment)
                .measures(measures)
                .cohortMeasures(measures)
                .organization(Organization.builder()
                        .organizationType(type)
                        .name("schoolName")
                        .id(organizationId)
                        .naturalId("schoolId")
                        .build());
    }

    static TargetRow.Builder targetRow(final OrganizationType type, final Long organizationId, final DimensionType dimensionType) {
        return TargetRow.builder()
                .dimension(Dimension.builder().type(dimensionType).build())
                .assessment(assessment)
                .measures(measures)
                .measures(measures)
                .organization(Organization.builder()
                        .organizationType(type)
                        .name("schoolName")
                        .id(organizationId)
                        .naturalId("schoolId")
                        .build());
    }


    static AggregateOrganizationQuery.Builder toQueryBuilderWithCommonAttributes(final AbstractAggregateReportQuery reportQuery, final StudentFilters filters) {
        return addCommonAttributes(AggregateOrganizationQuery.builder()
                        .assessmentGradeCodes(reportQuery.getAssessmentGradeCodes())
                        .subjectCodes(reportQuery.getSubjectCodes())
                        .schoolYears(reportQuery.getSchoolYears()),
                reportQuery, filters);
    }

    static LongitudinalOrganizationQuery.Builder toLongitudinalQueryBuilderWithCommonAttributes(final AbstractAggregateReportQuery reportQuery, final StudentFilters filters) {
        return addCommonAttributes(LongitudinalOrganizationQuery.builder()
                        .subjectCode(reportQuery.getSubjectCodes().iterator().next()),
                reportQuery, filters);
    }

    static ClaimOrganizationQuery.Builder toQueryClaimBuilderWithCommonAttributes(final ClaimAggregateReportQuery reportQuery, final StudentFilters filters) {
        return addCommonAttributes(ClaimOrganizationQuery.builder()
                        .assessmentGradeCodes(reportQuery.getAssessmentGradeCodes())
                        .claimCodesBySubject(reportQuery.getClaimCodesBySubject())
                        .schoolYears(reportQuery.getSchoolYears()),
                reportQuery, filters);
    }

    static TargetOrganizationQuery.Builder toQueryClaimBuilderWithCommonAttributes(final TargetReportQuery reportQuery, final StudentFilters filters) {
        return addCommonAttributes(TargetOrganizationQuery.builder()
                        .assessmentGradeCode(reportQuery.getAssessmentGradeCodes().iterator().next())
                        .schoolYear(reportQuery.getSchoolYear())
                        .subjectCode(reportQuery.getSubjectCode()),
                reportQuery, filters);
    }

    private static <B extends OrganizationTypeQuery.Builder> B addCommonAttributes(final B builder,
                                                                                   final AbstractAggregateReportQuery reportQuery,
                                                                                   final StudentFilters filters) {
        return (B) builder
                .assessmentTypeCode(reportQuery.getAssessmentTypeCode())
                .completenessCodes(reportQuery.getCompletenessCodes())
                .administrativeConditionCodes(reportQuery.getAdministrativeConditionCodes())
                .genderCodes(filters.getGenderCodes())
                .ethnicityCodes(filters.getEthnicityCodes())
                .lepCodes(filters.getLepCodes())
                .elasCodes(filters.getElasCodes())
                .migrantStatusCodes(filters.getMigrantStatusCodes())
                .section504Codes(filters.getSection504Codes())
                .iepCodes(filters.getIepCodes())
                .economicDisadvantageCodes(filters.getEconomicDisadvantageCodes());
    }
}
