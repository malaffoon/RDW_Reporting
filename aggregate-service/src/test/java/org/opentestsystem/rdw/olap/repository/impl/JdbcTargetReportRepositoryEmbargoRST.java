package org.opentestsystem.rdw.olap.repository.impl;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.model.TargetOrganizationQuery;
import org.opentestsystem.rdw.olap.model.TargetReportResult;
import org.opentestsystem.rdw.olap.repository.TargetReportRepository;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;

import static com.google.common.collect.ImmutableSet.of;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.School;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.EmbargoRead;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.individualOf;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

@SuppressWarnings({"SqlNoDataSourceInspection", "SqlResolve"})
@ActiveProfiles({"redshift", "redshift-embargo"})
public class JdbcTargetReportRepositoryEmbargoRST extends RepositoryBackedIT {

    @Autowired
    private TargetReportRepository repository;

    private final static int mathTargetsCount = 11;

    private static final TargetOrganizationQuery school8districts18Sum1999Query = TargetOrganizationQuery.builder()
            .assessmentGradeCode("-4")
            .organizationType(OrganizationType.School)
            .organizationIds(of(-8L))
            .schoolYear(1999)
            .subjectCode("Math")
            .assessmentTypeCode(SUMMATIVE.code())
            .dimensionType(Overall)
            .build();

    private User.Builder userBuilder;

    @Before
    public void setUp() {
        userBuilder = User.builderExt()
                .id("userId")
                .username("someone-10@somewhere.com")
                .password("redacted")
                .permissionsById(permissions(individualOf(PermissionScope.STATEWIDE)));
    }

    @Sql(scripts = {"classpath:TargetEntitiesSetup.sql"})
    @Test
    public void isShouldReturnExamsWithEmbargoEnabledForDistrictEmbargoAdmin() {
        final TargetReportResult report = repository.findByOrganizationType(userBuilder
                        .permissionsById(permissions(new Permission(AggregateRead, PermissionScope.builder()
                                        .statewide(false)
                                        .addDistrictIds(of(-17L, -18L, -19L))
                                        .addSchoolIds(of(-7L, -8L, -9L, -10L))
                                        .build()),
                                new Permission(EmbargoRead, PermissionScope.builder()
                                        .statewide(false)
                                        .addDistrictIds(of(-18L))
                                        .build()))).build(),
                school8districts18Sum1999Query, School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isTrue();
        assertThat(report.getPayload().size()).isEqualTo(mathTargetsCount);
        assertThat(report.getPayload().get(0).getMeasures().getStudentCount()).isEqualTo(3);
    }

    @Sql(scripts = {"classpath:TargetEntitiesSetup.sql"})
    @Test
    public void isShouldNotReturnExamsWithEmbargoEnabledForNonEmbargoAdmin() {
        final TargetReportResult report = repository.findByOrganizationType(userBuilder.build(), school8districts18Sum1999Query, School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getPayload().size()).isEqualTo(mathTargetsCount);
        assertThat(report.getPayload().get(0).getMeasures().getStudentCount()).isEqualTo(0);
    }


    @Sql(scripts = {"classpath:TargetEntitiesSetup.sql"}, statements = {"UPDATE school SET embargo_enabled = 0 WHERE district_id = -18"})
    @Test
    public void isShouldReturnExamsForDistrictsWithEmbargoReleased() {
        TargetReportResult report = repository.findByOrganizationType(userBuilder.build(), school8districts18Sum1999Query, School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getPayload().size()).isEqualTo(mathTargetsCount);
        assertThat(report.getPayload().get(0).getMeasures().getStudentCount()).isEqualTo(3);
    }

    @Sql(scripts = {"classpath:TargetEntitiesSetup.sql"},
            statements = {
                    "INSERT INTO state_embargo (aggregate, migrate_id) VALUES (1, -10)",
                    "INSERT INTO asmt_active_year (asmt_id, school_year) VALUES (-8, 1998)",
                    "UPDATE exam_target_score SET school_year = 1998 WHERE asmt_id = -8",
                    "UPDATE exam SET school_year = 1998 WHERE asmt_id = -8"
            })
    @Test
    public void isShouldReturnPreviousYearExamsRegardlessOfEmbargo() {
        final TargetReportResult report = repository.findByOrganizationType(userBuilder.build(), school8districts18Sum1999Query
                .copy()
                .schoolYear(1998)
                .build(), School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getPayload().size()).isEqualTo(mathTargetsCount);
        assertThat(report.getPayload().get(0).getMeasures().getStudentCount()).isEqualTo(3);
    }

    @Sql(scripts = {"classpath:TargetEntitiesSetup.sql"})
    @Test
    public void isShouldReturnExamsWithEmbargoEnabledForStateEmbargoAdmin() {
        final TargetReportResult report = repository.findByOrganizationType(userBuilder
                        .permissionsById(permissions(new Permission(AggregateRead, PermissionScope.builder()
                                        .statewide(false)
                                        .addDistrictIds(of(-17L, -18L, -19L))
                                        .addSchoolIds(of(-7L, -8L, -9L, -10L))
                                        .build()),
                                new Permission(EmbargoRead, PermissionScope.builder()
                                        .statewide(true)
                                        .build()))).build(),
                school8districts18Sum1999Query, School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isTrue();
        assertThat(report.getPayload().size()).isEqualTo(mathTargetsCount);
        assertThat(report.getPayload().get(0).getMeasures().getStudentCount()).isEqualTo(3);
    }
}
