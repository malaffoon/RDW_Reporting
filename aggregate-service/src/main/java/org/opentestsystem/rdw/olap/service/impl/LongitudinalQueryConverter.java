package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.model.LongitudinalOrganizationQuery;
import org.opentestsystem.rdw.olap.model.LongitudinalOrganizationQuery.Builder;
import org.opentestsystem.rdw.olap.service.LongitudinalYearGradeService;
import org.opentestsystem.rdw.olap.sqlbuilder.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.reporting.common.model.LongitudinalReportQuery;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import static com.google.common.base.Preconditions.checkArgument;

/*
 * Responsible for converting {@link LongitudinalReportQuery} into a collection
 * of corresponding {@link LongitudinalOrganizationQuery} queries
 */
@Component
class LongitudinalQueryConverter extends AbstractQueryConverter<LongitudinalReportQuery, LongitudinalOrganizationQuery, Builder> {

    private final LongitudinalYearGradeService longitudinalYearGradeService;

    @Autowired
    LongitudinalQueryConverter(final QueryProviderRepositoryHelper repositoryHelper,
                               final LongitudinalYearGradeService longitudinalYearGradeService) {
        super(repositoryHelper);
        this.longitudinalYearGradeService = longitudinalYearGradeService;
    }

    @Override
    protected LongitudinalOrganizationQuery.Builder getOrganizationTypeQueryBuilder(final LongitudinalReportQuery reportQuery,
                                                                                    final StudentFilters filters) {
        checkArgument(reportQuery.getSubjectCodes().size() == 1, "Only one subject is supported for the longitudinal report queries");

        return LongitudinalOrganizationQuery.builder()
                .subjectCode(reportQuery.getSubjectCodes().iterator().next())
                .gradeYearPairs(longitudinalYearGradeService.toYearGradePairs(reportQuery.getToSchoolYear(), reportQuery.getAssessmentGradeCodes()));
    }

    @Override
    protected boolean isSupportMultipleSubjects() {
        return false;
    }
}