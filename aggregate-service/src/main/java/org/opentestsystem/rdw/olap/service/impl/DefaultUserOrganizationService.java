package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.service.OrganizationService;
import org.opentestsystem.rdw.olap.service.UserOrganizationService;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationQuery;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Set;
import java.util.function.Predicate;
import java.util.stream.Stream;

import static com.google.common.collect.ImmutableSet.toImmutableSet;
import static org.apache.commons.lang.StringUtils.isBlank;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;

@Service
class DefaultUserOrganizationService implements UserOrganizationService {

    private final OrganizationService service;

    @Autowired
    DefaultUserOrganizationService(final OrganizationService service) {
        this.service = service;
    }

    @Override
    public Set<Organization> getOrganizations(final User user) {
        return getUserOrganizationsAsStream(user)
                .collect(toImmutableSet());
    }

    @Override
    public Set<Organization> getOrganizations(final User user, final OrganizationQuery query) {
        return getUserOrganizationsAsStream(user)
                .filter(toNamePredicate(query))
                .filter(toTypePredicate(query))
                .filter(toIdPredicate(query))
                .collect(toImmutableSet());
    }

    private Stream<Organization> getUserOrganizationsAsStream(final User user) {
        final PermissionScope permissionScope = user.getPermissionScopeByPermissionId(AggregateRead);

        final Predicate<Organization> securityFilter = permissionScope.isStatewide()
                ? organization -> true
                : permissionScopeContainsOrganization(permissionScope);

        return service.getSchoolsAndDistricts().stream()
                .filter(securityFilter);
    }

    /**
     * @param permissionScope the permission scope to test containership with
     * @return predicate that evaluates true when the tested organization is contained within the organization IDs of the permission scope
     */
    private Predicate<Organization> permissionScopeContainsOrganization(final PermissionScope permissionScope) {
        return organization -> {

            // If it's a district make sure the district is in the permission scope
            if (organization.getOrganizationType() == OrganizationType.District) {
                final District district = (District) organization;
                return permissionScope.getDistrictIds().contains(district.getId())
                        || permissionScope.getDistrictGroupIds().contains(district.getDistrictGroupId());
            }

            // If it's a school make sure the school or school's district is in the permission scope
            if (organization.getOrganizationType() == OrganizationType.School) {
                final School school = (School) organization;
                return permissionScope.getInstitutionIds().contains(school.getId())
                        || permissionScope.getInstitutionGroupIds().contains(school.getSchoolGroupId())
                        || permissionScope.getDistrictIds().contains(school.getDistrictId())
                        || permissionScope.getDistrictGroupIds().contains(school.getDistrictGroupId());
            }

            // If the org is not a school or district we are not interested in providing it
            return false;
        };
    }

    private Predicate<Organization> toNamePredicate(final OrganizationQuery query) {
        //If we're not querying on name, include all results
        if (query.getName() == null) {
            return organization -> true;
        }

        //If we're querying on name, but have no value, do not include any results
        if (isBlank(query.getName())) {
            return organization -> false;
        }

        //Filter organizations by name
        return organization ->
                organization.getName().toLowerCase().contains(query.getName().toLowerCase());
    }

    private Predicate<Organization> toTypePredicate(final OrganizationQuery query) {
        if (query.getTypes().isEmpty()) {
            return organization -> true;
        }

        return organization ->
                query.getTypes().contains(organization.getOrganizationType());
    }

    private Predicate<Organization> toIdPredicate(final OrganizationQuery query) {
        if (query.getIds().isEmpty()) {
            return organization -> true;
        }

        return organization ->
                query.getIds().contains(organization.getId());
    }

}
