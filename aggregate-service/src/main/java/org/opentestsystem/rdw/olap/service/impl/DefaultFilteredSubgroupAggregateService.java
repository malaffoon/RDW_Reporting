package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.AggregateReportSettings;
import org.opentestsystem.rdw.olap.model.AggregateReportQuery;
import org.opentestsystem.rdw.olap.model.FilteredSubgroupReportResult;
import org.opentestsystem.rdw.olap.repository.CustomAggregateReportRepository;
import org.opentestsystem.rdw.olap.service.AuthorizationService;
import org.opentestsystem.rdw.olap.service.BasicAggregateService;
import org.opentestsystem.rdw.olap.service.FilteredSubgroupAggregateService;
import org.opentestsystem.rdw.olap.sqlbuilder.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.reporting.common.model.AggregateQuery;
import org.opentestsystem.rdw.reporting.common.model.FilteredSubgroupReportQuery;
import org.opentestsystem.rdw.reporting.common.model.FilteredSubgroupRow;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.task.TaskExecutor;
import org.springframework.stereotype.Service;

import java.util.Collection;
import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.opentestsystem.rdw.reporting.common.model.AggregateQueryType.FilteredSubgroup;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;

/**
 * Default implementation of an {@link BasicAggregateService} backed by a repository
 */
@Service
class DefaultFilteredSubgroupAggregateService extends AbstractCustomAggregateService<FilteredSubgroupReportQuery, FilteredSubgroupRow, FilteredSubgroupReportResult, FilteredSubgroupReportResult.Builder> implements FilteredSubgroupAggregateService {

    @Autowired
    DefaultFilteredSubgroupAggregateService(
            final CustomAggregateReportRepository<FilteredSubgroupReportResult> repository,
            final AuthorizationService authorizationService,
            final AggregateReportSettings settings,
            final QueryProviderRepositoryHelper repositoryHelper,
            final TaskExecutor threadPoolTaskExecutor) {
        super(repository, authorizationService, settings, repositoryHelper, threadPoolTaskExecutor);
    }

    @Override
    public boolean handles(final AggregateQuery query) {
        return FilteredSubgroup.equals(query.getQueryType());
    }

    @Override
    protected FilteredSubgroupReportResult.Builder getReportBuilder() {
        return FilteredSubgroupReportResult.builder();
    }

    @Override
    protected Collection<AggregateReportQueryDescription> toOrganizationTypeQueries(final FilteredSubgroupReportQuery reportQuery) {
        final List<AggregateReportQueryDescription> queries = newArrayList();

        //each pair of organization/dimension is represented by a separate OrganizationTypeQuery
        for (final String subgroupsKey : reportQuery.getSubgroups().keySet()) {
            final AggregateReportQuery commonQuery = toQueryBuilderWithCommonAttributes(reportQuery, reportQuery.getSubgroups().get(subgroupsKey))
                    .subgroupKey(subgroupsKey)
                    .dimensionType(Overall)
                    .build();

            // for each level of organization add one or more builders to the result
            appendState(reportQuery, queries, commonQuery);
            appendDistricts(reportQuery, queries, commonQuery);
            appendSchools(reportQuery, queries, commonQuery);
        }
        return queries;
    }

    private static FilteredSubgroupReportQuery ensureOverallSubgroup(final FilteredSubgroupReportQuery query) {
        return query.getSubgroups().keySet().contains(Overall.name()) ? query : query.copy().subgroup(Overall.name(), StudentFilters.builder().build()).build();
    }

    @Override
    protected FilteredSubgroupReportQuery checkIsValid(final FilteredSubgroupReportQuery query) {
        return super.checkIsValid(ensureOverallSubgroup(query));
    }
}