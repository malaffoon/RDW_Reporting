package org.opentestsystem.rdw.reporting.processor.tasking;

import org.opentestsystem.rdw.reporting.processor.service.ReportRemovalService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.TaskScheduler;
import org.springframework.scheduling.annotation.Scheduled;

import java.time.temporal.ChronoUnit;
import java.util.Date;

import static java.time.Instant.now;

/**
 * This task invokes the report removal service.<br/>
 * It delays execution by a random amount because there may be multiple instances of the app
 * running and we want to avoid wasted duplicate work.
 *
 * It does not have a stereotype annotation because it is instantiated conditionally in
 * {@link org.opentestsystem.rdw.reporting.processor.configuration.RemoveStaleReportsConfiguration}.<br/>
 */
public class RemoveStaleReportsTask {
    private static final Logger logger = LoggerFactory.getLogger(RemoveStaleReportsTask.class);

    private final ReportRemovalService reportRemovalService;
    private final TaskScheduler taskScheduler;
    private final int maxReportLifetimeDays;
    private final int maxRandomMinutes;

    public RemoveStaleReportsTask(final ReportRemovalService reportRemovalService,
                                  final TaskScheduler taskScheduler,
                                  final int maxReportLifetimeDays,
                                  final int maxRandomMinutes) {
        this.reportRemovalService = reportRemovalService;
        this.taskScheduler = taskScheduler;
        this.maxReportLifetimeDays = maxReportLifetimeDays;
        this.maxRandomMinutes = maxRandomMinutes;
    }

    @Scheduled(cron = "${task.remove-stale-reports.cron}", zone = "GMT")
    public void removeStaleReports() {
        final long delay = (long) (Math.random() * maxRandomMinutes + 0.5);
        logger.info("Scheduled task triggered: Remove Stale Reports. Delaying {} minutes.", delay);
        taskScheduler.schedule(() -> {
            logger.info("Deleting stale reports");
            reportRemovalService.deleteOldReports(maxReportLifetimeDays);
        }, Date.from(now().plus(delay, ChronoUnit.MINUTES)));
    }
}
