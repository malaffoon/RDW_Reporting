package org.opentestsystem.rdw.reporting.processor.service;

import com.amazonaws.services.s3.Headers;
import org.apache.commons.io.IOUtils;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.rdw.archive.ArchiveService;
import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.web.ReportContentResource;
import org.opentestsystem.rdw.reporting.processor.MockBuilder;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.net.URI;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.anyString;
import static org.mockito.Mockito.doAnswer;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class ArchiveBackedReportContentServiceTest {

    @Mock
    private ArchiveService archiveService;

    @Mock
    private ReportService reportService;

    private Map<String, byte[]> archive;
    private ArchiveBackedReportContentService service;

    @Before
    public void setup() {
        archive = new HashMap<>();

        doAnswer(invocation -> {
            final String location = invocation.getArgumentAt(0, String.class);
            final InputStream content = invocation.getArgumentAt(1, InputStream.class);
            final byte[] contentBytes = IOUtils.toByteArray(content);
            archive.put(location, contentBytes);
            return null;
        }).when(archiveService).writeResource(anyString(), any(InputStream.class), any(Properties.class));

        when(archiveService.openResource(anyString())).thenAnswer(invocation -> {
            final String location = invocation.getArgumentAt(0, String.class);
            if (!archive.containsKey(location)) return null;

            return new ByteArrayInputStream(archive.get(location));
        });

        when(archiveService.readProperties(anyString())).thenAnswer(invocation -> {
            final Properties properties = new Properties();
            final String location = invocation.getArgumentAt(0, String.class);
            if (!archive.containsKey(location)) return properties;

            properties.put(Headers.CONTENT_LENGTH, (long) archive.get(location).length);
            return properties;
        });

        when(reportService.update(any(Report.class)))
                .thenAnswer(invocation -> invocation.getArgumentAt(0, Report.class));

        service = new ArchiveBackedReportContentService(archiveService, reportService);
    }

    @Test
    public void itShouldWriteContentsToTheArchiveService() throws Exception {
        final Report original = MockBuilder.report();

        try (final InputStream contents = new ByteArrayInputStream("Contents".getBytes())) {
            final Report updated = service.writeContent(original, contents, 123L);

            final ReportContentResource resource = service.openContent(updated);
            try (final InputStream retrievedContents = resource.getInputStream()) {
                assertThat(IOUtils.toString(retrievedContents)).isEqualTo("Contents");
            }
            assertThat(resource.contentLength()).isGreaterThan(0);
        }
    }

    @Test
    public void itShouldReturnNullWhenOpeningAnAbsentReport() {
        final Report report = MockBuilder.report()
                .copy()
                .reportResourceUri(URI.create("no_report_here.pdf"))
                .build();

        assertThat(service.openContent(report)).isNull();
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldThrowIfOpeningAReportWithoutAResourceLocation() {
        final Report report = MockBuilder.report()
                .copy()
                .reportResourceUri(null)
                .build();

        service.openContent(report);
    }
}