package org.opentestsystem.rdw.reporting.processor.model.jackson;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.guava.GuavaModule;
import com.google.common.collect.ImmutableSet;
import com.google.common.io.Resources;
import org.apache.commons.io.IOUtils;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.common.model.CustomAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.opentestsystem.rdw.reporting.common.model.jackson.AggregateReportModule;
import org.opentestsystem.rdw.reporting.processor.model.AbstractExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.AggregateReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.ExportExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.GroupExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.SchoolGradeExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.StudentExamReportRequest;

import java.io.InputStream;
import java.net.URL;
import java.util.Locale;

import static com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;
import static com.google.common.collect.Lists.newArrayList;
import static com.google.common.collect.Sets.newHashSet;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Ethnicity;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Gender;

public class AbstractExamReportRequestDeserializerTest {

    private ObjectMapper objectMapper;

    @Before
    public void setup() {
        objectMapper = new ObjectMapper();
        objectMapper.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        objectMapper.registerModules(new GuavaModule(), new ReportModule(), new AggregateReportModule());
    }

    @Test
    public void itShouldRoundTripASchoolGradeRequest() throws Exception {
        final SchoolGradeExamReportRequest request = SchoolGradeExamReportRequest.builder()
                .gradeId(11)
                .schoolId(123)
                .schoolYear(1234)
                .build();
        final String json = objectMapper.writeValueAsString(request);
        final SchoolGradeExamReportRequest deserialized = (SchoolGradeExamReportRequest) objectMapper.readValue(json, AbstractExamReportRequest.class);
        assertThat(deserialized.getGradeId()).isEqualTo(11);
        assertThat(deserialized.getSchoolId()).isEqualTo(123);
        assertThat(deserialized.getSchoolYear()).isEqualTo(1234);
    }

    @Test
    public void itShouldRoundTripAGroupRequest() throws Exception {
        final GroupExamReportRequest request = GroupExamReportRequest.builder()
                .groupId(123L)
                .schoolYear(1234)
                .build();
        final String json = objectMapper.writeValueAsString(request);
        final GroupExamReportRequest deserialized = (GroupExamReportRequest) objectMapper.readValue(json, AbstractExamReportRequest.class);
        assertThat(deserialized.getSchoolYear()).isEqualTo(1234);
        assertThat(deserialized.getGroupId()).isEqualTo(123);
    }

    @Test
    public void itShouldRoundTripAStudentRequest() throws Exception {
        final StudentExamReportRequest request = StudentExamReportRequest.builder()
                .studentId(123)
                .schoolYear(1234)
                .build();
        final String json = objectMapper.writeValueAsString(request);
        final StudentExamReportRequest deserialized = (StudentExamReportRequest) objectMapper.readValue(json, AbstractExamReportRequest.class);
        assertThat(deserialized.getStudentId()).isEqualTo(123);
        assertThat(deserialized.getSchoolYear()).isEqualTo(1234);
    }

    @Test
    public void itShouldRoundTripAnExamExportRequest() throws Exception {
        final ExportExamReportRequest request = ExportExamReportRequest.builder()
                .districtIds(ImmutableSet.of(123L, 456L))
                .schoolYear(1234)
                .build();
        final String json = objectMapper.writeValueAsString(request);
        final ExportExamReportRequest deserialized = (ExportExamReportRequest) objectMapper.readValue(json, AbstractExamReportRequest.class);
        assertThat(deserialized.getDistrictIds()).containsOnly(123L, 456L);
        assertThat(deserialized.getSchoolYear()).isEqualTo(1234);
    }

    @Test
    public void itShouldRoundTripAnAggregateReportRequest() throws Exception {
        final StudentFilters filters = StudentFilters.builder()
                .genderCodes(newHashSet("Gender"))
                .ethnicityCodes(newHashSet("Ethnicity"))
                .lepCodes(newHashSet("LEP"))
                .migrantStatusCodes(newHashSet("Migrant"))
                .section504Codes(newHashSet("504"))
                .iepCodes(newHashSet("IEP"))
                .economicDisadvantageCodes(newHashSet("Eco"))
                .build();

        final CustomAggregateReportQuery query = CustomAggregateReportQuery.builder()
                .assessmentTypeCode("AssessmentType")
                .subjectCodes(newHashSet("ELA"))
                .schoolYears(newHashSet(1999))
                .assessmentGradeCodes(newHashSet("Grades"))
                .includeState(true)
                .includeAllDistricts(true)
                .includeAllSchoolsOfDistricts(true)
                .includeAllDistrictsOfSchools(true)
                .districtIds(newHashSet(123L))
                .schoolIds(newHashSet(456L))
                .completenessCodes(newHashSet("Completeness"))
                .administrativeConditionCodes(newHashSet("AdminCond"))
                .valueDisplayType("ValueDisplay")
                .achievementLevelDisplayType("AchievementDisplay")
                .columnOrder(newArrayList("ColumnOrder"))
                .dimensionTypes(newHashSet(Gender))
                .studentFilters(filters)
                .build();

        final AggregateReportRequest request = AggregateReportRequest.builder()
                .query(query)
                .name("My Report")
                .language(Locale.US)
                .build();

        final String json = objectMapper.writeValueAsString(request);
        final AggregateReportRequest deserialized = objectMapper.readValue(json, AggregateReportRequest.class);
        assertThat(deserialized.getQuery()).isEqualToComparingFieldByFieldRecursively(request.getQuery());
    }

    @Test
    public void itShouldDeserializeALegacyAggregateReportRequestAnAggregateReportRequest() throws Exception {
        final URL serializedLegacyResource = Resources.getResource("serialized-aggregate-report-request-1_2.json");
        try (final InputStream resourceData = serializedLegacyResource.openStream()) {
            final String legacyRequestJson = IOUtils.toString(resourceData);
            final AggregateReportRequest deserialized = objectMapper.readValue(legacyRequestJson, AggregateReportRequest.class);

            assertThat(deserialized.getSchoolYear()).isEqualTo(2018);
            assertThat(deserialized.getName()).isEqualTo("Custom Aggregate Report");

            final CustomAggregateReportQuery query = (CustomAggregateReportQuery) deserialized.getQuery();
            assertThat(query.getAssessmentTypeCode()).isEqualTo("sum");
            assertThat(query.getSubjectCodes()).containsOnly("ELA", "Math");
            assertThat(query.getSchoolYears()).containsOnly(2018);
            assertThat(query.getAssessmentGradeCodes()).containsOnly("06");
            assertThat(query.isIncludeState()).isTrue();
            assertThat(query.isIncludeAllDistricts()).isFalse();
            assertThat(query.isIncludeAllSchoolsOfDistricts()).isFalse();
            assertThat(query.isIncludeAllDistrictsOfSchools()).isTrue();
            assertThat(query.getDistrictIds()).isEmpty();
            assertThat(query.getSchoolIds()).isEmpty();
            assertThat(query.getCompletenessCodes()).containsOnly("Complete");
            assertThat(query.getAdministrativeConditionCodes()).containsOnly("Valid");
            assertThat(query.getDimensionTypes()).containsOnly(Gender, Ethnicity);
            assertThat(query.getValueDisplayType()).isEqualTo("Percent");
            assertThat(query.getAchievementLevelDisplayType()).isEqualTo("Separate");
            assertThat(query.getColumnOrder()).containsExactly(
                    "organization",
                    "assessmentGrade",
                    "schoolYear",
                    "dimension");

            final StudentFilters filters = query.getStudentFilters();
            assertThat(filters.getGenderCodes()).containsOnly("Male");
            assertThat(filters.getEthnicityCodes()).containsOnly("White", "Asian");
            assertThat(filters.getLepCodes()).isEmpty();
            assertThat(filters.getMigrantStatusCodes()).containsOnly("yes");
            assertThat(filters.getSection504Codes()).containsOnly("yes");
            assertThat(filters.getIepCodes()).containsOnly("no");
            assertThat(filters.getEconomicDisadvantageCodes()).containsOnly("no");
        }
    }

    @Test
    public void itShouldSupportV1_2AbstractExamReportRequests() throws Exception {
        final URL serializedLegacyResource = Resources.getResource("serialized-school-group-report-request-1_2.json");
        try (final InputStream resourceData = serializedLegacyResource.openStream()) {
            final String schoolGradeExamRequest_v1_2 = IOUtils.toString(resourceData);
            final AbstractExamReportRequest deserialized = objectMapper.readValue(schoolGradeExamRequest_v1_2, AbstractExamReportRequest.class);
            assertThat(deserialized).isEqualToComparingOnlyGivenFields(
                    SchoolGradeExamReportRequest.builder()
                            .assessmentTypeCode("ica")
                            .subjectCode("Math")
                            .build(),
                    "assessmentTypeCode",
                    "subjectCode"
            );
        }
    }

}