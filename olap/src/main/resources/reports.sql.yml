sqlbuilder:
  templates:
      customAggregate:
        clauses:
          select: >-
              count(*) AS count,
              round(avg(scale_score)) AS score,
              sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1,
              sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2,
              sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3,
              sum(CASE WHEN performance_level = 4 THEN 1 ELSE 0 END) AS level4,
              fe.asmt_id,
              fe.asmt_grade_id,
              fe.school_year,
              a.subject_id

          from: >-
              fact_student_ica_exam fe

          join: >-
              JOIN ica_asmt a ON a.id = fe.asmt_id

          where: >-
              fe.school_year IN (:school_years) AND
              fe.asmt_grade_id IN (:asmt_grade_ids) AND
              a.grade_id IN (:asmt_grade_ids) AND
              a.subject_id in (:subject_ids)

          groupBy: >-
              fe.school_year,
              fe.asmt_id,
              fe.asmt_grade_id,
              a.subject_id

      # ------------ state ---------------------------------------------------------------------------
        addons:
            state:
              clauses:
                select: >-
                     'state' AS org_type,
                     NULL AS org_id,
                     NULL AS org_name

      # ---------- all districts  -------------------------------------------------------------------
            allDistricts:
              clauses:
                select: >-
                     'district' AS org_type,
                     d.id AS org_id,
                     d.name AS org_name

                join: >-
                    JOIN school sch ON sch.id = fe.school_id
                    JOIN district d ON d.id = sch.district_id

                groupBy: >-
                     d.id,
                     d.name

      # ---------- list of districts  -----------------------------------------------------------------
            districts:
              clauses:
                where: >-
                    d.id in (:district_ids)

      # ---------- all schools   ----------------------------------------------------------------------

            allSchools:
              clauses:
                select: >-
                    'school' AS org_type,
                     sch.id AS org_id,
                     sch.name AS org_name

                join: >-
                     JOIN school sch ON sch.id = fe.school_id

                groupBy: >-
                     sch.id,
                     sch.name

      # ---------- list of schools   ----------------------------------------------------------------------
            schools:
              clauses:
                where: >-
                    sch.id in (:school_ids)

      # ---------- dimensions ----------------------------------------------------------------------------
            overall:
              clauses:
                select: >-
                    'overall' AS dimension,
                    NULL AS dimension_id

            gender:
              clauses:
                select: >-
                    'gender' AS dimension,
                     s.gender_id AS dimension_id

                join:
                     JOIN student s ON fe.student_id = s.id

                groupBy: >-
                     s.gender_id

            ethnicity:
              clauses:
                select: >-
                    'ethnicity' AS dimension,
                     se.ethnicity_id AS dimension_id

                join:
                     JOIN student_ethnicity se ON se.student_id = fe.student_id

                groupBy: >-
                     se.ethnicity_id