package org.opentestsystem.rdw.admin.service.impl;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.admin.repository.GroupRepository;
import org.opentestsystem.rdw.admin.repository.ImportRepository;
import org.opentestsystem.rdw.admin.service.SchoolService;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;

import java.util.HashMap;
import java.util.Map;

import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.security.PermissionScope.STATEWIDE;

@RunWith(MockitoJUnitRunner.class)
public class DefaultGroupServiceTest {

    @Mock
    private GroupRepository repository;

    @Mock
    private ImportRepository importRepository;

    @Mock
    private SchoolService schoolService;

    @Mock
    public User user;

    private DefaultGroupService service;

    @Before
    public void setup() {
        service = new DefaultGroupService(repository, importRepository, schoolService);

        final Map<String, Permission> permissions = new HashMap<>();
        final Permission permission = new Permission("GROUP_WRITE", STATEWIDE);
        permissions.put("GROUP_WRITE", permission);
        when(user.getPermissionsById()).thenReturn(permissions);
        when(user.getUsername()).thenReturn("user@example.com");
    }

    @Test
    public void itShouldDeleteAGroupWithAnImport() {
        final long importId = 123L;
        when(importRepository.createGroupDelete("user@example.com"))
                .thenReturn(importId);
        final long groupId = 456L;

        service.delete(user, groupId);
        verify(repository).delete(STATEWIDE, groupId, importId);
        verify(importRepository).setProcessed(importId);
    }

}