package org.opentestsystem.rdw.admin.multitenant.configuiration;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.cache.CacheBuilder;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cache.guava.GuavaCacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

import javax.sql.DataSource;
import java.util.concurrent.TimeUnit;
import org.opentestsystem.rdw.admin.multitenant.administration.SandboxArchiveRemovalService;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationProcessor;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatusService;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatusSyncService;
import org.opentestsystem.rdw.admin.multitenant.administration.impl.DefaultSandboxArchiveRemovalService;
import org.opentestsystem.rdw.admin.multitenant.administration.impl.DefaultTenantAdministrationRequestHandler;
import org.opentestsystem.rdw.admin.multitenant.administration.impl.DefaultTenantAdministrationStatusService;
import org.opentestsystem.rdw.admin.multitenant.administration.impl.DefaultTenantAdministrationStatusSyncService;
import org.opentestsystem.rdw.admin.multitenant.configprops.ConfigpropsConsolidationService;
import org.opentestsystem.rdw.admin.multitenant.configprops.ConfigpropsPublicationStorage;
import org.opentestsystem.rdw.admin.multitenant.configprops.ConfigpropsService;
import org.opentestsystem.rdw.admin.multitenant.configprops.ConfigpropsUpdateSubscriber;
import org.opentestsystem.rdw.admin.multitenant.configprops.DefaultConfigpropsPublicationStorage;
import org.opentestsystem.rdw.admin.multitenant.configprops.DefaultConfigpropsService;
import org.opentestsystem.rdw.admin.multitenant.configprops.PublicationStorageConfigpropsClient;
import org.opentestsystem.rdw.admin.multitenant.configserver.ConfigServerClient;
import org.opentestsystem.rdw.admin.multitenant.configserver.DefaultConfigServerClient;
import org.opentestsystem.rdw.admin.multitenant.database.MultitenantAdminConfiguration;
import org.opentestsystem.rdw.admin.multitenant.database.MultitenantDatabaseAdmin;
import org.opentestsystem.rdw.admin.multitenant.database.TenantDatabaseAdminOrchestrationService;
import org.opentestsystem.rdw.admin.multitenant.database.impl.DefaultTenantDatabaseAdminOrchestrationService;
import org.opentestsystem.rdw.admin.multitenant.git.GitTenantConfigurationPersistenceService;
import org.opentestsystem.rdw.admin.multitenant.git.TenantConfigurationPersistenceProperties;
import org.opentestsystem.rdw.admin.multitenant.git.TenantConfigurationPersistenceService;
import org.opentestsystem.rdw.admin.multitenant.service.TenantConfigurationViewService;
import org.opentestsystem.rdw.reporting.common.stream.MessageSecurityService;

@Configuration
@EnableCaching
public class TenantAdministrationConfiguration {

    @Value("${spring.cloud.config.uri}")
    private String configServerUri;

    @Bean
    public DefaultTenantDatabaseAdminOrchestrationService tenantDatabaseAdminOrchestrationService(final MultitenantDatabaseAdmin multitenantDatabaseAdmin,
                                                                                                  @Qualifier("adminReportingDataSource") final DataSource adminReportingDataSource,
                                                                                                  @Qualifier("adminWarehouseDataSource") final DataSource adminWarehouseDataSource,
                                                                                                  @Qualifier("adminOlapDataSource") final DataSource adminOlapDataSource) {
        return new DefaultTenantDatabaseAdminOrchestrationService(multitenantDatabaseAdmin,
                adminReportingDataSource,
                adminWarehouseDataSource,
                adminOlapDataSource);
    }

    @Bean
    public GitTenantConfigurationPersistenceService tenantConfigurationPersistenceService(TenantConfigurationPersistenceProperties tenantConfigurationPersistenceProperties,
                                                                                          ConfigServerClient configServerClient) {
        return new GitTenantConfigurationPersistenceService(tenantConfigurationPersistenceProperties, configServerClient);
    }

    @Bean
    public DefaultTenantAdministrationRequestHandler tenantAdministrationRequestHandler(MessageSecurityService messageSecurityService,
                                                                                        TenantAdministrationProcessor tenantAdministrationProcessor,
                                                                                        TenantDatabaseAdminOrchestrationService tenantDatabaseAdminOrchestrationService,
                                                                                        TenantConfigurationPersistenceService tenantConfigurationPersistenceService,
                                                                                        ConfigServerClient configServerClient,
                                                                                        TenantAdministrationStatusService tenantAdministrationStatusService,
                                                                                        SandboxArchiveRemovalService sandboxArchiveRemovalService) {
        return new DefaultTenantAdministrationRequestHandler(messageSecurityService,
                tenantAdministrationProcessor,
                tenantDatabaseAdminOrchestrationService,
                tenantConfigurationPersistenceService,
                configServerClient,
                tenantAdministrationStatusService,
                sandboxArchiveRemovalService);
    }

    @Bean
    public TenantAdministrationStatusService tenantAdministrationStatusService() {
        return new DefaultTenantAdministrationStatusService();
    }

    @Bean
    public SandboxArchiveRemovalService sandboxArchiveRemovalService(final TenantConfigurationViewService tenantConfigurationViewService) {
        return new DefaultSandboxArchiveRemovalService(tenantConfigurationViewService);
    }

    @Bean
    public RestTemplateBuilder restTemplateBuilder() {
        return new RestTemplateBuilder();
    }

    @Bean
    public RestTemplate configpropsRestTemplate(RestTemplateBuilder restTemplateBuilder) {
        return restTemplateBuilder
                .setConnectTimeout(1000)
                .setReadTimeout(3000)
                .build();
    }

    @Bean
    public PublicationStorageConfigpropsClient configpropsClient(ConfigpropsPublicationStorage configpropsPublicationStorage) {
        return new PublicationStorageConfigpropsClient(configpropsPublicationStorage);
    }

    @Bean
    public DefaultConfigServerClient defaultConfigServerClient() {
        return new DefaultConfigServerClient(configServerUri);
    }

    @Bean
    public DefaultConfigpropsService configpropsService(ConfigpropsConsolidationService configpropsConsolidationService,
                                                        ObjectMapper mapper) {
        return new DefaultConfigpropsService(configpropsConsolidationService, mapper);
    }

    @Bean
    public CacheManager configpropsCacheManager() {
        GuavaCacheManager cacheManager = new GuavaCacheManager("configpropsCache");
        CacheBuilder<Object, Object> cacheBuilder = CacheBuilder.newBuilder()
                .maximumSize(100)
                .expireAfterWrite(30, TimeUnit.SECONDS);
        cacheManager.setCacheBuilder(cacheBuilder);
        return cacheManager;
    }

    @Bean
    public ConfigpropsPublicationStorage configpropsPublicationStorage() {
        return new DefaultConfigpropsPublicationStorage();
    }

    @Bean
    public ConfigpropsUpdateSubscriber configpropsUpdateSubscriber(ConfigpropsPublicationStorage configpropsPublicationStorage) {
        return new ConfigpropsUpdateSubscriber(configpropsPublicationStorage);
    }

    @Bean
    @ConfigurationProperties("sql.multitenantDatabaseAdmin")
    public MultitenantAdminConfiguration adminSqlConfiguration() {
        return new MultitenantAdminConfiguration();
    }

    @Bean
    public TenantAdministrationStatusSyncService tenantAdministrationStatusSyncService(TenantAdministrationStatusService statusService,
                                                                                       ConfigpropsService configpropsService,
                                                                                       ConfigServerClient configServerClient,
                                                                                       @Value("${app.multitenant.statusSync.createDelayMinutes:5}") Long createDelayMinutes,
                                                                                       @Value("${app.multitenant.statusSync.updateDelayMinutes:1}") Long updateDelayMinutes) {
        return new DefaultTenantAdministrationStatusSyncService(statusService,
                configpropsService,
                configServerClient,
                createDelayMinutes,
                updateDelayMinutes);
    }

}
