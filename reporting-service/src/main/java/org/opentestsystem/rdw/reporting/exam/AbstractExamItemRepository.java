package org.opentestsystem.rdw.reporting.exam;

import org.opentestsystem.rdw.reporting.common.jdbc.ExamItems;
import org.opentestsystem.rdw.reporting.common.jdbc.SecurityParameterProvider;
import org.opentestsystem.rdw.reporting.common.model.ExamItem;
import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.validation.constraints.NotNull;
import java.util.List;
import java.util.Map;

public abstract class AbstractExamItemRepository<T extends AbstractExamSearch> implements ExamItemRepository<T> {

    private final NamedParameterJdbcTemplate template;
    private final SecurityParameterProvider securityParameterProvider;
    private final String findAllExamItemScoresForAssessmentQuery;

    protected AbstractExamItemRepository(
            @NotNull final NamedParameterJdbcTemplate template,
            @NotNull final SecurityParameterProvider securityParameterProvider,
            @NotNull final String findAllExamItemScoresForAssessmentQuery) {
        this.template = template;
        this.securityParameterProvider = securityParameterProvider;
        this.findAllExamItemScoresForAssessmentQuery = findAllExamItemScoresForAssessmentQuery;
    }

    abstract protected Map<String, Object> getParameters(final T search);

    /**
     * Allows for overriding the query string if it changes based on the search
     */
    protected String getFindAllExamItemScoresForAssessmentQuerySql(@NotNull final T search) {
        return findAllExamItemScoresForAssessmentQuery;
    }

    @Override
    public List<ExamItem> findAllExamItemScoresForAssessment(@NotNull final PermissionSource permissionSource, @NotNull final T search) {

        return template.query(
                getFindAllExamItemScoresForAssessmentQuerySql(search),
                new MapSqlParameterSource()
                        .addValues(securityParameterProvider.getSecurityParameters(permissionSource))
                        .addValue("school_year", search.getSchoolYear())
                        .addValue("assessment_id", search.getAssessmentId())
                        .addValues(getParameters(search)),
                (row, index) -> ExamItems.map(row)
        );
    }
}
