package org.opentestsystem.rdw.reporting.organization;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;

import static com.google.common.collect.Lists.newArrayList;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.IndividualPiiRead;


@RunWith(SpringRunner.class)
@ActiveProfiles("test")
public class DefaultOrganizationServiceTest {

    @MockBean
    private OrganizationRepository repository;

    @MockBean
    private User user;

    private DefaultOrganizationService service;

    @Before
    public void before() {
        when(user.getPermissionsById())
                .thenReturn(ImmutableMap.of(
                        IndividualPiiRead, new Permission(IndividualPiiRead, PermissionScope.STATEWIDE)
                ));
        this.service = new DefaultOrganizationService(repository);
    }

    @Test
    public void getSchoolsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getSchools(user);
        verify(repository).findAllSchools(PermissionScope.STATEWIDE);
    }

    @Test
    public void getDistrictsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getDistricts(user);
        verify(repository).findAllDistricts(PermissionScope.STATEWIDE);
    }

    @Test
    public void getSchoolGroupsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getSchoolGroups(user);
        verify(repository).findAllSchoolGroups(PermissionScope.STATEWIDE);
    }

    @Test
    public void getDistrictGroupsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getDistrictGroups(user);
        verify(repository).findAllDistrictGroups(PermissionScope.STATEWIDE);
    }

}
