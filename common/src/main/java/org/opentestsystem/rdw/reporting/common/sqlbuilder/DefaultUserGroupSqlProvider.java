package org.opentestsystem.rdw.reporting.common.sqlbuilder;

import org.opentestsystem.rdw.reporting.common.model.UserGroupType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.PropertyPlaceholderHelper;

import java.util.Properties;

import static org.opentestsystem.rdw.reporting.common.model.UserGroupType.Teacher;


@Service
public class DefaultUserGroupSqlProvider implements UserGroupSqlProvider {

    private final PropertyPlaceholderHelper propertyPlaceholderHelper = new PropertyPlaceholderHelper("$[", "]");

    private final Properties teacherProperties;
    private final Properties adminProperties;

    @Autowired
    public DefaultUserGroupSqlProvider(@Value("${sql.snippet.adminUserGroups.join}") final String adminUserGroupsJoinSql,
                                       @Value("${sql.snippet.adminUserGroups.filter}") final String adminUserGroupsFilterSql,
                                       @Value("${sql.snippet.teacherGroups.join}") final String teacherGroupsJoinSql,
                                       @Value("${sql.snippet.teacherGroups.filter}") final String teacherGroupsFilterSql) {
        teacherProperties = new Properties();
        teacherProperties.put("groupJoinPlaceholder", teacherGroupsJoinSql);
        teacherProperties.put("groupFilterPlaceholder", teacherGroupsFilterSql);

        adminProperties = new Properties();
        adminProperties.put("groupJoinPlaceholder", adminUserGroupsJoinSql);
        adminProperties.put("groupFilterPlaceholder", adminUserGroupsFilterSql);
    }

    @Override
    public String getSqlForGroupOfType(final String sql, final UserGroupType type) {
        return propertyPlaceholderHelper.replacePlaceholders(sql, type == Teacher ? teacherProperties : adminProperties);
    }
}