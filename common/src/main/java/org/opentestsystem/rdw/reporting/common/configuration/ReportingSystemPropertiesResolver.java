package org.opentestsystem.rdw.reporting.common.configuration;

import com.fasterxml.jackson.annotation.JsonView;
import org.opentestsystem.rdw.multitenant.TenantKeyResolver;
import org.opentestsystem.rdw.reporting.common.model.SearchFieldPermissionLevel;
import org.opentestsystem.rdw.reporting.common.model.StudentFieldType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Stream;

public class ReportingSystemPropertiesResolver implements ReportingSystemProperties {

    private static final Logger logger = LoggerFactory.getLogger(ReportingSystemPropertiesResolver.class);

    private final TenantKeyResolver tenantKeyResolver;
    private final ReportingSystemSettings reportingSystemSettings;

    public ReportingSystemPropertiesResolver(TenantKeyResolver tenanKeyResolver,
                                             ReportingSystemSettings reportingSystemSettings) {
        this.tenantKeyResolver = tenanKeyResolver;
        this.reportingSystemSettings = reportingSystemSettings;
        logger.debug("ReportingSystemSettings {}", reportingSystemSettings);
    }

    private Optional<ReportingSystemProperties> getResolvedReportingSystemProperties() {
        return tenantKeyResolver.getTenantKey()
                .flatMap(k -> Optional.ofNullable(reportingSystemSettings.getTenants().get(k)));
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getAnalyticsTrackingId() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getAnalyticsTrackingId)
                .orElse(reportingSystemSettings.getAnalyticsTrackingId());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getInterpretiveGuideUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getInterpretiveGuideUrl)
                .orElse(reportingSystemSettings.getInterpretiveGuideUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getAccessDeniedUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getAccessDeniedUrl)
                .orElse(reportingSystemSettings.getAccessDeniedUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getLandingPageUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getLandingPageUrl)
                .orElse(reportingSystemSettings.getLandingPageUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getIrisVendorId() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getIrisVendorId)
                .orElse(reportingSystemSettings.getIrisVendorId());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Integer getMinItemDataYear() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getMinItemDataYear)
                .orElse(reportingSystemSettings.getMinItemDataYear());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Boolean isPercentileDisplayEnabled() {
        final Optional<Boolean> resolved =
                getResolvedReportingSystemProperties().map(ReportingSystemProperties::isPercentileDisplayEnabled);
        final Optional<Boolean> fallback =
                Optional.ofNullable(reportingSystemSettings.isPercentileDisplayEnabled());
        return Stream.of(resolved, fallback)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .findFirst()
                .orElse(false);
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public List<String> getReportLanguages() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getReportLanguages)
                .orElse(reportingSystemSettings.getReportLanguages());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Integer getSchoolYear() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getSchoolYear)
                .orElse(reportingSystemSettings.getSchoolYear());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public StateProperties getState() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getState)
                .orElse(reportingSystemSettings.getState());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Boolean isTransferAccessEnabled() {
        final Optional<Boolean> resolved =
                getResolvedReportingSystemProperties().map(ReportingSystemProperties::isTransferAccessEnabled);
        final Optional<Boolean> fallback =
                Optional.ofNullable(reportingSystemSettings.isTransferAccessEnabled());
        return Stream.of(resolved, fallback)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .findFirst()
                .orElse(false);
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getTranslationLocation() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getTranslationLocation)
                .orElse(reportingSystemSettings.getTranslationLocation());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public List<String> getUiLanguages() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getUiLanguages)
                .orElse(reportingSystemSettings.getUiLanguages());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getUserGuideUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getUserGuideUrl)
                .orElse(reportingSystemSettings.getUserGuideUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public TargetReportProperties getTargetReport() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getTargetReport)
                .orElse(reportingSystemSettings.getTargetReport());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Map<StudentFieldType, SearchFieldPermissionLevel> getStudentFields() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getStudentFields)
                .orElse(reportingSystemSettings.getStudentFields());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public List<String> getEffectiveReportLanguages() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getEffectiveReportLanguages)
                .orElse(reportingSystemSettings.getEffectiveReportLanguages());
    }

}
